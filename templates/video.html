{% extends "base.html" %}

{% block content %}
 <head>
     <meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond&family=Elsie&family=Fjalla+One&family=Source+Serif+Pro:wght@300&display=swap" rel="stylesheet">
    <link type="text/css" rel="stylesheet" href="../static/css/video.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
     <link rel="icon" href="../static/img/DecCar/icon.png" type="image/jpg" sizes="128x128">
     <title>清醒派 - 实时检测</title>
     <script type="text/javascript">
    window._AMapSecurityConfig = {
        securityJsCode:'e56781f3ea8f14e94b5dad4defac18e2',
    }
    // window.onload = function() {
    // performPlaceSearch()
    // }

</script>
</head>

<!--导航栏-->
<section>
<div class="Images"></div>
<section id="section-1">
    <div class="Nav-Bar">
        <ul class="Navigation-Bar">
            <a class="title" href="{{url_for('index')}}"><img class="logo" src="{{url_for('static', filename='/img/DecCar/icon.png')}}" width="90px" height="100px"></a>
            <a class="topnav-left" href="{{url_for('index')}}">清醒派</a>
        <div class="topnav-right">
            <li class="Nav-Link"><a  href="{{url_for('index')}}"><i style="padding-right:10px;" class="fa fa-home"></i>首页</a></li>
            <li class="Nav-Link"><a  href="{{url_for('about')}}"><i style="padding-right:10px;" class="fa fa-tree"></i>关于</a></li>
            <li class="Nav-Link"><a  href="{{url_for('video',)}}"><i style="padding-right:10px;" class="fa fa-list-ul"></i>检测</a></li>
            <li class="Nav-Link"><a  href="{{url_for('report', )}}"><i style="padding-right:10px;" class="fa fa-leaf"></i>报告</a></li>
            <li class="Nav-Link"><a  href="{{url_for('index')}}#section8"><i style="padding-right:10px;" class="fa fa-phone"></i>介绍</a></li>
        </div>
        </ul>
        </div>

</section>
</section>

<!--部署--->
<div class="section-2">
    <!--这个是四张可视化的图片，通过访问graph-feed实时获取-->
    <script src="https://fastly.jsdelivr.net/gh/stevenjoezhang/live2d-widget@latest/autoload.js"></script>
    <div class="image-container">
        <img src="{{ url_for('graph_feed', filename='perclos', xlabel='DurationOfSession', ylabel='PercentageOfEyeClosure', title='PercentageOfEyeClosureDuringSessions') }}" onload="imageloaded();">
         <img src="{{ url_for('graph_feed',filename='head', xlabel='DurationOfSession', ylabel='Headtilt', title='HeadTiltDuringTheSession') }}" onload="imageloaded();">
         <img src="{{ url_for('graph_feed',filename='ear', xlabel='Duration of session', ylabel='EyeAspectRatio', title='EyeAspectRatioDuringSession') }}" onload="imageloaded();">
         <img src="{{ url_for('graph_feed',filename='mar', xlabel='DurationOfSession', ylabel='MouthAspectRatio', title='MouthAspectRatioDuringTheSession') }}" onload="imageloaded();">
    </div>

    <div class="video">
<!--    这个是视频框，通过访问video-feed获取每一帧-->
        <div class = "Realvideo">
            <img src="{{ url_for('video_feed') }}" onload="imageloaded();"/>
        </div>
        <h1 id='feed' class="centered">正在加载实时视频</h1>

        <div id='fancy-spinner' class="fancy-spinner precentered" >
            <div id='ring' class="ring"></div>
            <div id='dot'  class="dot"></div>
        </div>
    </div>

    <div class="text-box">
        <!-- 在视频框的右侧添加文本框 -->
        <p id="driveTime">您已经行驶了</p>

        <button class="start-button" id="play-btn">播放音频</button>
        <p id="status">加载定位</p>
        <p id="result">当前位置</p>
        <div class="bottom-div">
          <button class="start-button">开始导航</button>
        </div>
    </div>
</div>


<section>
    <div class="Section-3">
        <img src="../static/img/DecCar/icon.png" height="100px" width="85px">
        <h2 class="result">疲劳程度</h2>
        <div class="container">
            <div class="skills html">90%</div>
        </div>
    </div>
</section>

{% raw %}
<script src="../static/js/audio.js">
</script>
<script>
    window.onload = function() {
  startAudio("和小派开启安全之旅吧！");
};
</script>
<script type="text/javascript" src="https://webapi.amap.com/maps?v=2.0&key=5b6a4518ce8fbf1b1636b112b983ee0a"></script>
<script type="text/javascript">
    var geolocation;
   AMap.plugin('AMap.Geolocation', function() {
        geolocation = new AMap.Geolocation({
            enableHighAccuracy: true,//是否使用高精度定位，默认:true
            timeout: 10000,          //超过10秒后停止定位，默认：5s
            buttonPosition:'RB',    //定位按钮的停靠位置
            buttonOffset: new AMap.Pixel(10, 20),//定位按钮与设置的停靠位置的偏移量，默认：Pixel(10, 20)
            zoomToAccuracy: true,   //定位成功后是否自动调整地图视野到定位点
            needAddress: true,

        });
        // map.addControl(geolocation);
        geolocation.getCurrentPosition(function(status,result){
            if(status=='complete'){
                onComplete(result)
                console.log(result);
                console.log(position_ie);

            }else{
                onError(result)
            }
        });
    });

// 解析定位结果
    function onComplete(data) {

        document.getElementById('status').innerHTML='定位成功'
        var str = [];
        str.push('定位结果：' + data.position);
        str.push('定位类别：' + data.location_type);
        /*str.push('详细位置：' + data.formattedAddress);*/
        var position_de = data.formattedAddress;
        position_ie = data.formattedAddress;
        str.push('位置：' + position_de);
        if(data.accuracy){
            str.push('精度：' + data.accuracy + ' 米');
        }//如为IP精确定位结果则没有精度信息
        str.push('是否经过偏移：' + (data.isConverted ? '是' : '否'));
        document.getElementById('result').innerHTML = str.join('<br>');
        document.getElementById('startPoint').innerHTML=position_de;
        startAudio("您当前的位置是"+position_de);
    }
    //解析定位错误信息
    function onError(data) {
        document.getElementById('status').innerHTML='定位失败'
        document.getElementById('result').innerHTML = '失败原因排查信息:'+data.message;
    }

</script>
     <script>
        var playBtn = document.getElementById("play-btn");
        var audio = new Audio();

        var audioFiles = [
            "../music/1.ogg",
            "../music/2.ogg",
            "../music/3.ogg",
            "../music/4.ogg"
        ];

        playBtn.addEventListener("click", function() {
            var randomIndex = Math.floor(Math.random() * audioFiles.length);
            var randomFile = audioFiles[randomIndex];

            audio.src = randomFile;
            audio.play();
        });
    </script>
{% endraw %}
{% endblock content %}

